<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ClipScribe Desktop</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <a class="skip-link" href="#main-workspace">Skip To Main Content</a>
    <div class="app-shell">
      <aside class="sidebar">
        <div class="sidebar-header">
          <h1>ClipScribe</h1>
          <span class="sidebar-badge">Desktop</span>
        </div>
        <p class="sidebar-subtitle">Project folders and session history.</p>

        <section class="sidebar-section">
          <div class="sidebar-section-head">
            <p class="sidebar-section-title">Folders</p>
            <button id="delete-folder-btn" class="sidebar-inline-btn" type="button">Delete</button>
          </div>
          <span id="selected-folder-hint" class="sidebar-subtitle sidebar-folder-hint">No folder selected</span>
          <div class="folder-create-row">
            <input id="new-folder-name" type="text" autocomplete="off" placeholder="Create a folder..." />
            <button id="new-folder-btn">Add</button>
          </div>
          <div id="folder-list" class="folder-list"></div>
        </section>
      </aside>

      <main id="main-workspace" class="workspace">
        <header class="topbar panel">
          <div>
            <h2 id="workspace-title">Meeting Capture Workspace</h2>
            <p id="workspace-subtitle" class="muted">
              Capture meeting and call audio, then review timestamped transcript chunks for notes, docs, or AI workflows.
            </p>
          </div>
          <div class="topbar-right">
            <div id="active-status" class="status-pill status-pill-large">Idle</div>
          </div>
        </header>

        <nav class="workspace-tabs panel" role="tablist" aria-label="Workspace Views">
          <button id="nav-capture-btn" class="workspace-tab active" role="tab" aria-selected="true" aria-controls="capture-view" type="button">Capture</button>
          <button id="nav-settings-btn" class="workspace-tab" role="tab" aria-selected="false" aria-controls="settings-view" type="button">Settings</button>
        </nav>

        <div id="shortcut-hints" class="shortcut-strip panel">Shortcuts: <kbd>Esc</kbd> pause/resume, <kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>R</kbd> start/stop, <kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>C</kbd> copy transcript</div>

        <section id="capture-view" class="view">
          <nav class="subtabs panel" role="tablist" aria-label="Capture Sections">
            <button id="capture-tab-setup" class="subtab active" role="tab" aria-selected="true" aria-controls="capture-setup-panel" type="button">Setup</button>
            <button id="capture-tab-sessions" class="subtab" role="tab" aria-selected="false" aria-controls="capture-sessions-panel" type="button">Sessions</button>
            <button id="capture-tab-transcript" class="subtab" role="tab" aria-selected="false" aria-controls="capture-transcript-panel" type="button">Transcript</button>
          </nav>

          <section id="capture-setup-panel" class="capture-pane">
            <section class="panel controls-panel">
              <div class="panel-title-row setup-title-row">
                <div class="setup-title-stack">
                  <h3>Session Setup</h3>
                  <p class="panel-intro">Create a session, choose sources, then start capture and monitor live transcript chunks.</p>
                </div>
                <span id="session-folder-context" class="muted setup-folder-context">Folder: -</span>
              </div>
              <div class="flow-steps" aria-label="Capture flow">
                <span id="flow-step-session" class="flow-step active">
                  <span class="flow-step-index">1</span>
                  <span>Session Details</span>
                </span>
                <span id="flow-step-sources" class="flow-step">
                  <span class="flow-step-index">2</span>
                  <span>Choose Sources</span>
                </span>
                <span id="flow-step-recording" class="flow-step">
                  <span class="flow-step-index">3</span>
                  <span>Start Recording</span>
                </span>
              </div>
              <section class="setup-block">
                <div class="setup-block-head">
                  <h4>Session Details</h4>
                  <span class="muted">Saved when you start recording</span>
                </div>
                <div class="grid-row">
                  <label>
                    Session Title
                    <input id="session-title" name="session_title" type="text" autocomplete="off" placeholder="Meeting - Product Sync..." />
                  </label>
                  <label>
                    Chunk Interval (Sec)
                    <input id="chunk-seconds" name="chunk_seconds" type="number" min="30" step="30" value="120" />
                  </label>
                </div>
              </section>

              <section class="setup-block">
                <div class="source-header">
                  <h4>Sources</h4>
                  <div class="actions compact-actions">
                    <button id="source-picker-toggle">Pick Sources</button>
                    <button id="test-selected-source-btn">Test Selected</button>
                    <button id="refresh-sources-btn">Refresh</button>
                  </div>
                </div>
                <div id="selected-sources-summary" class="selected-sources-summary"></div>
                <div id="source-picker-panel" class="source-picker-panel hidden">
                  <input id="source-search" class="source-search" type="text" autocomplete="off" placeholder="Search sources..." />
                  <div id="source-filter-pills" class="source-filter-pills">
                    <button class="source-filter-pill active" type="button" data-source-filter="all">All</button>
                    <button class="source-filter-pill" type="button" data-source-filter="system-output">System Output</button>
                    <button class="source-filter-pill" type="button" data-source-filter="app-loopback">App Loopback</button>
                    <button class="source-filter-pill" type="button" data-source-filter="system-inputs">System Inputs</button>
                    <button class="source-filter-pill" type="button" data-source-filter="microphones">Mics</button>
                  </div>
                  <div id="source-list" class="source-list"></div>
                </div>
                <div class="setup-actions-row">
                  <div class="actions compact-actions source-apply-row">
                    <button id="start-from-setup-btn" class="accent">Start & Open Transcript</button>
                    <button id="apply-sources-btn">Apply Source Changes</button>
                  </div>
                  <p id="setup-action-hint" class="panel-note muted">Apply Source Changes is available only while a recording is active.</p>
                </div>
                <div id="source-test-feedback" class="source-test-feedback hidden">
                  <div class="source-test-summary">
                    <span id="source-test-result" class="muted">No test clip yet.</span>
                    <span id="source-test-quality" class="source-test-quality">No signal data</span>
                  </div>
                  <canvas id="source-test-wave" class="source-test-wave" width="640" height="84" aria-label="Audio waveform preview"></canvas>
                  <div class="actions compact-actions">
                    <button id="play-last-test-btn" type="button">Play Last Test</button>
                  </div>
                </div>
              </section>
            </section>
          </section>

          <section id="capture-sessions-panel" class="capture-pane hidden">
            <section class="panel sessions-panel">
              <div class="panel-title-row">
                <h3 id="sessions-heading">Sessions</h3>
                <div class="actions compact-actions session-actions">
                  <button id="open-transcript-btn">Open Transcript</button>
                  <button id="rename-session-btn">Rename</button>
                  <button id="delete-session-btn" class="danger">Delete</button>
                </div>
              </div>
              <p class="panel-intro">Search, rename, delete, and open session transcripts from this folder.</p>
              <div class="session-filter-row">
                <input id="sessions-search" type="text" autocomplete="off" placeholder="Search sessions..." />
                <select id="sessions-status-filter">
                  <option value="all">All</option>
                  <option value="active">Recording / Paused</option>
                  <option value="stopped">Stopped</option>
                </select>
              </div>
              <div id="sessions-list" class="sessions-list"></div>
            </section>
          </section>

          <section id="capture-transcript-panel" class="capture-pane hidden">
            <section class="panel detail-panel">
              <div class="panel-title-row">
                <h3>Transcript</h3>
                <div class="detail-head-actions">
                  <button id="copy-all-btn">Copy Transcript</button>
                  <div id="detail-meta" class="muted"></div>
                </div>
              </div>
              <div class="actions compact-actions transport-inline">
                <button id="record-btn" class="accent">Start</button>
                <button id="pause-btn">Pause</button>
                <button id="resume-btn">Resume</button>
                <button id="stop-btn" class="danger">Stop</button>
              </div>
              <div id="detail-estimate" class="detail-estimate"></div>
              <div id="detail-speakers" class="speaker-alias-panel hidden"></div>
              <nav class="detail-subtabs" role="tablist" aria-label="Transcript Detail Views">
                <button
                  id="detail-tab-timeline"
                  class="detail-subtab active"
                  role="tab"
                  aria-selected="true"
                  aria-controls="detail-events-pane"
                  type="button"
                >
                  <span class="detail-subtab-label">Timeline</span>
                  <span id="detail-tab-timeline-count" class="detail-tab-count hidden">0</span>
                </button>
                <button
                  id="detail-tab-summary"
                  class="detail-subtab"
                  role="tab"
                  aria-selected="false"
                  aria-controls="detail-summary-pane"
                  type="button"
                >
                  Summary
                </button>
                <button
                  id="detail-tab-transcript"
                  class="detail-subtab"
                  role="tab"
                  aria-selected="false"
                  aria-controls="detail-transcript-pane"
                  type="button"
                >
                  Transcript
                </button>
              </nav>
              <section id="detail-transcript-pane" class="detail-pane hidden">
                <div id="detail-chunks" class="chunks-list"></div>
              </section>
              <section id="detail-summary-pane" class="detail-pane hidden">
                <section id="detail-summary-panel" class="summary-panel">
                  <div class="panel-title-row">
                    <h4>Session Summary</h4>
                    <div class="actions compact-actions">
                      <button id="detail-generate-summary-btn">Regenerate</button>
                      <button id="detail-copy-summary-btn">Copy Summary</button>
                    </div>
                  </div>
                  <p id="detail-summary-meta" class="muted"></p>
                  <div id="detail-summary-text" class="summary-text"></div>
                </section>
              </section>
              <section id="detail-events-pane" class="detail-pane">
                <div id="detail-events" class="events-list timeline-list"></div>
              </section>
            </section>
          </section>
        </section>

        <section id="settings-view" class="view hidden">
          <nav class="subtabs panel" role="tablist" aria-label="Settings Sections">
            <button id="settings-tab-health" class="subtab active" role="tab" aria-selected="true" aria-controls="settings-health-panel" type="button">Setup Health</button>
            <button id="settings-tab-defaults" class="subtab" role="tab" aria-selected="false" aria-controls="settings-defaults-panel" type="button">Default Sources</button>
            <button id="settings-tab-transcription" class="subtab" role="tab" aria-selected="false" aria-controls="settings-transcription-panel" type="button">Transcription</button>
          </nav>

          <section id="settings-health-panel" class="settings-pane">
            <section class="panel health-panel">
              <div class="panel-title-row health-title-row">
                <h3>Setup Health</h3>
              </div>
              <p class="panel-intro">Use these maintenance actions when any health card reports an issue. If repair fails, close ClipScribe and run <code>npm run rebuild:native</code>.</p>
              <div class="health-actions-card">
                <div class="health-actions-head">
                  <p class="health-actions-title">Maintenance Actions</p>
                  <span class="muted">Run left to right</span>
                </div>
                <div class="actions health-actions">
                  <button id="detect-ffmpeg-btn">1. Auto-Detect FFmpeg Paths</button>
                  <button id="repair-native-btn">2. Repair Native Audio Modules</button>
                </div>
              </div>
              <div class="health-grid">
                <div id="health-native" class="health-card">Native modules: Unknown</div>
                <div id="health-ffmpeg" class="health-card">FFmpeg: Unknown</div>
                <div id="health-audio" class="health-card">Audio backend: Unknown</div>
                <div id="health-deepgram" class="health-card">Deepgram API key: Unknown</div>
              </div>
              <div id="setup-next-step" class="setup-next-step muted"></div>
            </section>
          </section>

          <section id="settings-defaults-panel" class="settings-pane hidden">
            <section class="panel settings-panel">
              <div class="panel-title-row">
                <h3>Default Sources</h3>
                <button id="save-default-sources-btn">Save Defaults</button>
              </div>
              <p class="muted">
                These are pre-selected when you start a new session. Use `Test` to verify before saving.
              </p>
              <input id="default-source-search" class="source-search" type="text" autocomplete="off" placeholder="Search default sources..." />
              <div id="default-source-list" class="source-list"></div>
            </section>
          </section>

          <section id="settings-transcription-panel" class="settings-pane hidden">
            <section class="panel transcription-panel">
              <div class="panel-title-row">
                <h3>Transcription Settings</h3>
              </div>
              <p class="panel-intro">
                Configure pre-recorded STT and summary defaults. ClipScribe uses batch transcription (not realtime streaming).
              </p>
              <nav class="transcription-subtabs" role="tablist" aria-label="Transcription Sections">
                <button
                  id="transcription-tab-providers"
                  class="transcription-subtab active"
                  role="tab"
                  aria-selected="true"
                  aria-controls="transcription-providers-pane"
                  type="button"
                >
                  Providers
                </button>
                <button
                  id="transcription-tab-usage"
                  class="transcription-subtab"
                  role="tab"
                  aria-selected="false"
                  aria-controls="transcription-usage-pane"
                  type="button"
                >
                  Usage
                </button>
              </nav>

              <section id="transcription-providers-pane" class="transcription-pane">
                <div class="transcription-form-grid">
                  <section class="transcription-card">
                    <div class="panel-title-row">
                      <h4>Deepgram (STT)</h4>
                    </div>
                    <div class="grid-row">
                      <label>
                        Deepgram Project ID (Optional)
                        <input id="deepgram-project-id" name="deepgram_project_id" type="text" autocomplete="off" spellcheck="false" placeholder="project_uuid" />
                      </label>
                      <label>
                        Model
                        <div class="model-picker-row">
                          <select id="deepgram-model" name="deepgram_model">
                            <option value="nova-3">nova-3</option>
                            <option value="nova-2">nova-2</option>
                          </select>
                          <button id="refresh-deepgram-models-btn" type="button">Sync Models</button>
                        </div>
                        <span id="deepgram-models-status" class="muted model-picker-status"></span>
                      </label>
                    </div>
                    <label>
                      Deepgram API Key
                      <input id="deepgram-api-key" name="deepgram_api_key" type="password" autocomplete="off" spellcheck="false" placeholder="dg_xxx..." />
                    </label>
                  </section>

                  <section class="transcription-card">
                    <div class="panel-title-row">
                      <h4>OpenRouter (Summary)</h4>
                    </div>
                    <div class="grid-row">
                      <label>
                        OpenRouter API Key
                        <input id="openrouter-api-key" name="openrouter_api_key" type="password" autocomplete="off" spellcheck="false" placeholder="sk-or-v1-..." />
                      </label>
                      <label>
                        OpenRouter Model
                        <div class="model-picker-row">
                          <select id="openrouter-model" name="openrouter_model">
                            <option value="openrouter/free">openrouter/free (Recommended Router)</option>
                            <option value="meta-llama/llama-3.1-70b-instruct:free">meta-llama/llama-3.1-70b-instruct:free</option>
                            <option value="mistralai/mistral-small-3.1-24b-instruct:free">mistralai/mistral-small-3.1-24b-instruct:free</option>
                            <option value="google/gemma-3-27b-it:free">google/gemma-3-27b-it:free</option>
                            <option value="google/gemma-3-12b-it:free">google/gemma-3-12b-it:free</option>
                            <option value="qwen/qwen-2.5-72b-instruct:free">qwen/qwen-2.5-72b-instruct:free</option>
                            <option value="__custom__">Custom model...</option>
                          </select>
                          <button id="refresh-openrouter-models-btn" type="button">Sync Free Models</button>
                        </div>
                        <input
                          id="openrouter-model-custom"
                          name="openrouter_model_custom"
                          class="hidden"
                          type="text"
                          autocomplete="off"
                          spellcheck="false"
                          placeholder="openai/gpt-5-mini"
                        />
                        <span id="openrouter-models-status" class="muted model-picker-status"></span>
                      </label>
                    </div>
                  </section>

                  <section class="transcription-card">
                    <div class="panel-title-row">
                      <h4>Processing And Cost</h4>
                    </div>
                    <div class="grid-row">
                      <label>
                        Chunk Interval (Sec)
                        <input id="chunk-seconds-settings" name="chunk_seconds_settings" type="number" min="30" step="30" />
                      </label>
                      <label>
                        Enhancement Profile
                        <select id="preprocess-profile" name="preprocess_profile">
                          <option value="fast">fast</option>
                          <option value="denoise">denoise</option>
                          <option value="off">off</option>
                        </select>
                      </label>
                    </div>
                    <div class="grid-row">
                      <label>
                        Max Preprocess Ms
                        <input id="preprocess-timeout-ms" name="preprocess_timeout_ms" type="number" min="1000" max="20000" step="500" />
                      </label>
                      <label>
                        Estimated STT USD / Minute
                        <input id="estimated-stt-usd-per-min" name="estimated_stt_usd_per_min" type="number" min="0" max="10" step="0.0001" />
                        <span id="estimated-stt-hint" class="muted model-picker-status"></span>
                      </label>
                    </div>
                  </section>
                </div>
                <div class="actions transcription-save-row">
                  <button id="save-settings-btn">Save Transcription Settings</button>
                </div>
              </section>

              <section id="transcription-usage-pane" class="transcription-pane hidden">
                <div class="transcription-usage-grid">
                  <div class="usage-breakdown-panel">
                    <div class="panel-title-row">
                      <h4>Deepgram Usage Breakdown</h4>
                      <button id="refresh-usage-btn" type="button">Refresh Deepgram</button>
                    </div>
                    <p class="panel-intro">
                      Endpoint: <code>listen</code>. Optional grouping by model/method/tag/deployment/accessor/endpoint.
                    </p>
                    <div class="usage-filter-row">
                      <label>
                        Start Date
                        <input id="usage-start-date" type="date" />
                      </label>
                      <label>
                        End Date
                        <input id="usage-end-date" type="date" />
                      </label>
                      <label>
                        Grouping
                        <select id="usage-grouping">
                          <option value="">none</option>
                          <option value="models">model</option>
                          <option value="method">method</option>
                          <option value="tags">tag</option>
                          <option value="feature_set">feature set</option>
                          <option value="deployment">deployment</option>
                          <option value="accessor">accessor</option>
                          <option value="endpoint">endpoint</option>
                        </select>
                      </label>
                    </div>
                    <div id="usage-summary" class="usage-summary"></div>
                    <div id="usage-list" class="usage-list"></div>
                  </div>
                  <div class="usage-breakdown-panel openrouter-usage-panel">
                    <div class="panel-title-row">
                      <h4>OpenRouter Usage</h4>
                      <button id="refresh-openrouter-usage-btn" type="button">Refresh OpenRouter</button>
                    </div>
                    <p class="panel-intro">
                      Key-level credits and rate-limit snapshot for summary generation.
                    </p>
                    <div id="openrouter-usage-summary" class="usage-summary"></div>
                    <div id="openrouter-usage-list" class="usage-list"></div>
                  </div>
                </div>
              </section>
            </section>
          </section>
        </section>

      </main>
    </div>

    <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>
    <script src="./app.js"></script>
  </body>
</html>
